<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retailer Enrollment Sheet - December 2025</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            color: #e2e8f0; 
            min-height: 100vh; 
            padding: 20px; 
            line-height: 1.6;
            transition: background 0.8s ease;
        }
        
        body.tier-platinum {
            background: linear-gradient(135deg, #2d3436 0%, #4a5568 50%, #636e72 100%);
        }
        
        body.tier-gold {
            background: linear-gradient(135deg, #3d3010 0%, #5c4a1a 50%, #7a6420 100%);
        }
        
        body.tier-executive {
            background: linear-gradient(135deg, #1a0505 0%, #3d1010 50%, #4a1515 100%);
        }
        
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: linear-gradient(145deg, rgba(25, 25, 40, 0.92), rgba(45, 45, 65, 0.92)); 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 20, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.06); 
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                rgba(180, 185, 195, 0.8), 
                rgba(255, 215, 0, 0.8), 
                rgba(220, 38, 38, 0.8),
                rgba(180, 185, 195, 0.8));
            animation: shimmer 4s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.6; transform: translateX(-100%); }
            50% { opacity: 1; transform: translateX(100%); }
        }
        
        h2 { 
            text-align: center; 
            padding: 28px 40px; 
            margin: -40px -40px 45px -40px; 
            font-size: 28px; 
            font-weight: 600; 
            border-radius: 24px 24px 0 0; 
            letter-spacing: 0.5px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 20, 0.4);
            background: linear-gradient(135deg, rgba(45, 45, 65, 0.9), rgba(60, 60, 85, 0.9));
            backdrop-filter: blur(15px);
        }
        
        .form-section { margin-bottom: 32px; }
        
        .form-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            margin-bottom: 20px; 
            font-size: 14px; 
            background: linear-gradient(145deg, rgba(40, 40, 55, 0.85), rgba(55, 55, 75, 0.85)); 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: 
                0 12px 40px rgba(0, 0, 20, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }
        
        .form-table th, .form-table td { 
            border: 1px solid rgba(90, 90, 120, 0.3); 
            padding: 16px 14px; 
            text-align: center; 
            transition: all 0.3s ease; 
        }
        
        .form-table th { 
            background: linear-gradient(135deg, rgba(55, 55, 75, 0.9), rgba(70, 70, 95, 0.9)); 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.3px; 
            color: #f1f5f9;
            font-size: 13px;
        }
        
        .form-table tr:hover { 
            background: rgba(120, 120, 140, 0.08); 
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 0, 20, 0.3);
        }
        
        .left { text-align: left !important; }
        
        .highlight, .total-display, .slab-highlight, .auto-calc { 
            font-weight: 600; 
            color: #fff; 
            background: linear-gradient(135deg, rgba(100, 100, 130, 0.9), rgba(130, 130, 160, 0.9));
        }
        
        .section-title { 
            background: linear-gradient(135deg, rgba(30, 30, 45, 0.95), rgba(45, 45, 60, 0.95)) !important; 
            font-weight: 600; 
            text-align: center; 
            font-size: 15px; 
            text-transform: uppercase; 
            color: #fbbf24;
            letter-spacing: 0.5px;
        }
        
        input[type="text"], input[type="number"] { 
            width: 100%; 
            height: 48px; 
            background: linear-gradient(145deg, rgba(55, 55, 75, 0.8), rgba(70, 70, 90, 0.8)); 
            border: 2px solid rgba(100, 100, 130, 0.4); 
            color: #f1f5f9; 
            padding: 12px 16px; 
            border-radius: 12px; 
            font-size: 14px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
        }
        
        input:focus { 
            outline: none; 
            border-color: rgba(120, 120, 140, 0.6); 
            box-shadow: 
                0 0 0 4px rgba(120, 120, 140, 0.15),
                0 8px 25px rgba(120, 120, 140, 0.1); 
            background: linear-gradient(145deg, rgba(120, 120, 140, 0.12), rgba(140, 140, 160, 0.08)); 
            transform: translateY(-1px);
        }
        
        input[readonly] { 
            cursor: not-allowed; 
            background: linear-gradient(145deg, rgba(100, 100, 120, 0.15), rgba(120, 120, 140, 0.1)) !important; 
            color: #fff !important;
        }
        
        .calc-section { 
            background: linear-gradient(135deg, rgba(40, 40, 55, 0.9), rgba(55, 55, 75, 0.9)); 
            padding: 32px; 
            border-radius: 20px; 
            margin: 35px 0; 
            box-shadow: 
                0 20px 50px rgba(0, 0, 20, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        
        .total-amount { 
            text-align: center; 
            font-size: 26px; 
            font-weight: 700; 
            padding: 28px; 
            border-radius: 20px; 
            margin: 35px 0; 
            text-shadow: 0 2px 8px rgba(0, 0, 20, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(70, 70, 90, 0.95), rgba(90, 90, 110, 0.95));
            transition: all 0.5s ease;
        }
        
        body.tier-platinum .total-amount {
            background: linear-gradient(135deg, rgba(140, 145, 155, 0.95), rgba(180, 185, 195, 0.95));
            box-shadow: 0 20px 50px rgba(180, 185, 195, 0.3);
            color: #1a1a2e;
        }
        
        body.tier-gold .total-amount {
            background: linear-gradient(135deg, rgba(218, 165, 32, 0.95), rgba(255, 193, 7, 0.95));
            box-shadow: 0 20px 50px rgba(255, 193, 7, 0.3);
            color: #1a1a2e;
        }
        
        body.tier-executive .total-amount {
            background: linear-gradient(135deg, rgba(185, 28, 28, 0.95), rgba(220, 38, 38, 0.95));
            box-shadow: 0 20px 50px rgba(220, 38, 38, 0.3);
            color: #fff;
        }
        
        .tier-section {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .tier-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: #e2e8f0;
            cursor: pointer;
            padding: 20px 32px;
            border-radius: 16px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            position: relative;
            overflow: hidden;
            min-width: 150px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(145deg, rgba(50, 50, 70, 0.6), rgba(65, 65, 85, 0.6));
            backdrop-filter: blur(15px);
        }
        
        .tier-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 20, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .tier-btn input[type="radio"] { 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
            transform: scale(1.1); 
            margin: 0;
        }
        
        .tier-platinum { border-color: rgba(180, 185, 195, 0.3); }
        .tier-platinum.active {
            background: linear-gradient(135deg, rgba(140, 145, 155, 0.95), rgba(180, 185, 195, 0.95));
            box-shadow: 0 20px 50px rgba(180, 185, 195, 0.4);
            transform: translateY(-6px);
            border-color: rgba(180, 185, 195, 0.6);
            color: #1a1a2e;
        }
        .tier-platinum input[type="radio"] { accent-color: #b4b9c3; }
        
        .tier-gold { border-color: rgba(255, 193, 7, 0.3); }
        .tier-gold.active {
            background: linear-gradient(135deg, rgba(218, 165, 32, 0.95), rgba(255, 193, 7, 0.95));
            box-shadow: 0 20px 50px rgba(255, 193, 7, 0.4);
            transform: translateY(-6px);
            border-color: rgba(255, 193, 7, 0.6);
            color: #1a1a2e;
        }
        .tier-gold input[type="radio"] { accent-color: #ffc107; }
        
        .tier-executive { border-color: rgba(220, 38, 38, 0.3); }
        .tier-executive.active {
            background: linear-gradient(135deg, rgba(185, 28, 28, 0.95), rgba(220, 38, 38, 0.95));
            box-shadow: 0 20px 50px rgba(220, 38, 38, 0.4);
            transform: translateY(-6px);
            border-color: rgba(220, 38, 38, 0.6);
            color: #fff;
        }
        .tier-executive input[type="radio"] { accent-color: #dc2626; }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 50px 0 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, rgba(100, 100, 130, 0.9), rgba(130, 130, 160, 0.9)); 
            color: #fff; 
            padding: 20px 44px; 
            border: none; 
            border-radius: 16px; 
            font-size: 15px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: hidden;
            min-width: 190px;
            box-shadow: 0 10px 30px rgba(100, 100, 130, 0.3);
            backdrop-filter: blur(15px);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s;
        }
        
        .btn:hover::before { left: 100%; }
        .btn:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 25px 50px rgba(100, 100, 130, 0.4); 
        }
        .btn:active { transform: translateY(-3px); }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .pdf-btn { min-width: 210px; }
        
        body.tier-platinum .btn {
            background: linear-gradient(135deg, rgba(140, 145, 155, 0.95), rgba(180, 185, 195, 0.95));
            box-shadow: 0 10px 30px rgba(180, 185, 195, 0.3);
            color: #1a1a2e;
        }
        body.tier-platinum .btn:hover {
            box-shadow: 0 25px 50px rgba(180, 185, 195, 0.5);
        }
        
        body.tier-gold .btn {
            background: linear-gradient(135deg, rgba(218, 165, 32, 0.95), rgba(255, 193, 7, 0.95));
            box-shadow: 0 10px 30px rgba(255, 193, 7, 0.3);
            color: #1a1a2e;
        }
        body.tier-gold .btn:hover {
            box-shadow: 0 25px 50px rgba(255, 193, 7, 0.5);
        }
        
        body.tier-executive .btn {
            background: linear-gradient(135deg, rgba(185, 28, 28, 0.95), rgba(220, 38, 38, 0.95));
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
            color: #fff;
        }
        body.tier-executive .btn:hover {
            box-shadow: 0 25px 50px rgba(220, 38, 38, 0.5);
        }
        
        .photo-section {
            margin: 25px 0;
            padding: 28px;
            background: linear-gradient(135deg, rgba(100, 100, 130, 0.12), rgba(130, 130, 160, 0.08));
            border-radius: 16px;
            border: 2px solid rgba(100, 100, 130, 0.2);
            display: none;
        }
        
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 14px;
            margin: 16px 0;
            border: 3px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 40px rgba(0, 0, 20, 0.4);
            display: none;
        }
        
        .geo-info {
            margin-top: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(35, 35, 50, 0.9));
            border-radius: 12px;
            font-size: 14px;
            border-left: 4px solid rgba(100, 100, 130, 0.6);
            display: none;
            font-weight: 500;
            color: #e2e8f0;
        }
        
        .geo-info.exif-source {
            border-left-color: #4CAF50;
        }
        
        .geo-info.device-source {
            border-left-color: #ff9800;
        }
        
        .geo-info.no-source {
            border-left-color: #f44336;
        }
        
        .geo-info small {
            color: rgba(226, 232, 240, 0.7);
            font-size: 12px;
        }
        
        .geo-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            text-transform: uppercase;
        }
        
        .geo-badge.exif {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .geo-badge.device {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }
        
        .geo-badge.none {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }
        
        .auto-label { 
            font-size: 12px; 
            color: rgba(251, 191, 36, 0.9); 
            display: block; 
            margin-top: 6px; 
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.2);
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
        }
        
        .loading-subtext {
            color: #aaa;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .debug-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            font-size: 11px;
            color: #888;
            display: none;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) { 
            .container { margin: 15px; padding: 28px; }
            .form-table { font-size: 13px; }
            .form-table th, .form-table td { padding: 14px 10px; }
            .tier-section, .action-buttons { flex-direction: column; align-items: center; gap: 20px; }
            .btn { min-width: 280px; }
            h2 { font-size: 24px; padding: 24px 28px; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- EXIF.js library for cross-platform EXIF extraction -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">üìç Extracting GPS from photo...</div>
        <div class="loading-subtext" id="loadingSubtext">Please wait while we read location data</div>
    </div>

    <div class="container">
        <h2>Retailer Enrollment Sheet - December 2025</h2>
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <table class="form-table">
                <tr><td class="left">Outlet Name</td><td><input type="text" id="outletName" placeholder="Enter outlet name"></td></tr>
                <tr><td class="left">Outlet Lapu No</td><td><input type="text" id="lapuNo" placeholder="Enter LAPU number"></td></tr>
                <tr><td class="left">FSE Contact No</td><td><input type="text" id="fseContact" placeholder="Enter FSE contact"></td></tr>
                <tr><td class="left">TSM/SE Name and Contact No</td><td><input type="text" id="tsmContact" placeholder="Enter TSM/SE details"></td></tr>
            </table>
        </div>

        <!-- Margin Scheme -->
        <div class="form-section">
            <table class="form-table">
                <tr><th>Scheme</th><th>Margin</th><th>Gate</th></tr>
                <tr><td class="left">Base Margins</td><td>3.90%</td><td>-</td></tr>
                <tr><td class="left">MNP Participation</td><td>1.40%</td><td>1 MNP / Day</td></tr>
                <tr><td class="left">WIFI Participation</td><td>1.50%</td><td>1 WIFI / Day</td></tr>
                <tr class="highlight"><td class="left">Total Margin</td><td>6.80%</td><td>-</td></tr>
            </table>
        </div>

        <!-- OTF Section -->
        <div class="form-section">
            <table class="form-table">
                <tr class="section-title"><td colspan="3">OTF</td></tr>
                <tr><th>FRC</th><th>DSR</th><th>MNP</th></tr>
                <tr><td>349</td><td>135</td><td>235</td></tr>
                <tr><td>449</td><td>135</td><td>235</td></tr>
                <tr><td colspan="3" class="left" style="text-align: center; font-weight: 600;">SIMEX ‚Äì Rs.50 Per SIMEX</td></tr>
            </table>
        </div>

        <!-- Main Calculation Section -->
        <div class="calc-section">
            <table class="form-table">
                <tr><th>Items</th><th>Count</th><th>Amount</th></tr>
                <tr><td class="left">DSR OTF - Rs.135</td><td><input type="number" id="dsrCount" placeholder="0" min="0"></td><td><input type="text" id="dsrAmount" readonly class="total-display"></td></tr>
                <tr><td class="left">MNP OTF - Rs.235</td><td><input type="number" id="mnpCount" placeholder="0" min="0"></td><td><input type="text" id="mnpAmount" readonly class="total-display"></td></tr>
                <tr class="gross-row slab-highlight">
                    <td class="left">GROSS COMMITMENT<br><span class="auto-label">Slab Rate √ó MNP Count</span></td>
                    <td><input type="text" id="grossCount" readonly class="auto-calc"></td>
                    <td><input type="text" id="grossAmount" readonly class="total-display slab-highlight"></td>
                </tr>
            </table>
        </div>

        <!-- Margin Calculations -->
        <div class="form-section">
            <table class="form-table">
                <tr class="section-title"><td colspan="3">Margin Calculations</td></tr>
                <tr><td class="left">Lapu Tertiary</td><td><input type="number" id="lapuTertiary" placeholder="0" min="0"></td><td><input type="text" id="tertiaryAmount" readonly class="total-display"></td></tr>
                <tr><td class="left">MNP Days</td><td><input type="number" id="mnpDays" placeholder="0" min="0"></td><td><input type="text" id="mnpDaysAmount" readonly class="total-display"></td></tr>
                <tr><td class="left">WiFi Days</td><td><input type="number" id="wifiDays" placeholder="0" min="0"></td><td><input type="text" id="wifiDaysAmount" readonly class="total-display"></td></tr>
            </table>
        </div>

        <!-- Additional Items -->
        <table class="form-table">
            <tr><td class="left">WIFI</td><td><input type="number" id="wifiCount" placeholder="0" min="0"></td><td><input type="text" id="wifiAmount" readonly class="total-display"></td></tr>
            <tr><td class="left">APB SBA</td><td><input type="number" id="apbCount" placeholder="0" min="0"></td><td><input type="text" id="apbAmount" readonly class="total-display"></td></tr>
            <tr><td class="left">SIMEX</td><td><input type="number" id="simexCount" placeholder="0" min="0"></td><td><input type="text" id="simexAmount" readonly class="total-display"></td></tr>
        </table>

        <div class="total-amount" id="totalAmount">Total Amount Rs. 0</div>
<div class="form-section" id="exclude-airtel-gross">
        <!-- Competitor Data -->
        <div class="form-section" id="exclude-competitor">
            <table class="form-table">
                <tr class="section-title">
                    <td><input type="text" id="viMnp" placeholder="VI MNP"></td>
                    <td><input type="text" id="viDsr" placeholder="VI DSR"></td>
                    <td><input type="text" id="jioMnp" placeholder="JIO MNP"></td>
                    <td><input type="text" id="jioDsr" placeholder="JIO DSR"></td>
                </tr>
            </table>
        </div>

        <div class="form-section" id="exclude-airtel">
            <table class="form-table">
                <tr class="section-title">
                    <td><input type="text" id="airtelGross" placeholder="Airtel 4g Gross"></td>
                    <td><input type="text" id="deviceShare" placeholder="Device Share" style="color: #60a5fa;"></td>
                </tr>
            </table>
        </div>
    </div>
        <!-- Tier Selection -->
        <div class="tier-section">
            <label class="tier-btn tier-platinum">
                <input type="radio" name="tier" id="chckPlat" value="platinum">
                <span>Platinum</span>
            </label>
            <label class="tier-btn tier-gold">
                <input type="radio" name="tier" id="chckGold" value="gold">
                <span>Gold</span>
            </label>
            <label class="tier-btn tier-executive">
                <input type="radio" name="tier" id="chckExec" value="executive">
                <span>Executive</span>
            </label>
        </div>

        <!-- Targets -->
        <div class="form-section" id="exclude-targets">
            <table class="form-table">
                <tr><th>DSR TARGET</th><th>MNP TARGET</th><th>TOTAL TARGET</th><th>WIFI TARGET</th></tr>
                <tr>
                    <td><input type="number" id="dsrTarget" placeholder="0" min="0"></td>
                    <td><input type="number" id="mnpTarget" placeholder="0" min="0"></td>
                    <td><input type="number" id="totalTarget" placeholder="0" min="0"></td>
                    <td><input type="number" id="wifiTarget" placeholder="0" min="0"></td>
                </tr>
            </table>
        </div>

        <!-- SLAB REFERENCE TABLE -->
        <div class="form-section">
            <table class="form-table">
                <tr><th>Gross Target SLAB</th><th>INCENTIVE (PER MNP)</th></tr>
                <tr><td>10</td><td>‚Çπ75/MNP</td></tr>
                <tr><td>20</td><td>‚Çπ125/MNP</td></tr>
                <tr><td>30</td><td>‚Çπ150/MNP</td></tr>
                <tr><td>40</td><td>‚Çπ175/MNP</td></tr>
                <tr class="slab-highlight"><td>50+</td><td class="slab-highlight">‚Çπ200/MNP</td></tr>
            </table>
        </div>

        <!-- Photo & Geo Section -->
        <div class="photo-section" id="photoSection">
            <img id="photoPreview" class="photo-preview" alt="Captured Photo">
            <div id="geoInfo" class="geo-info"></div>
            <div id="debugInfo" class="debug-info"></div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="captureBtn" class="btn photo-btn">Capture Photo</button>
            <button id="submitBtn" class="btn">Submit</button>
            <button id="pdfBtn" class="btn pdf-btn">Download PDF</button>
        </div>
    </div>

    <script>
        // =============================================
        // GOOGLE SHEETS CONFIGURATION
        // =============================================
        // PASTE YOUR GOOGLE SCRIPT WEB APP URL HERE:
        const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE';
        // Example: const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw.../exec';
        
        let capturedPhoto = null;
        let geoLocation = null;
        let geoSource = null;
        let geoAccuracy = null;
        let photoTimestamp = null;
        let selectedTier = null;
        let originalFile = null;
        let preCaptureLoctaion = null;

        // =============================================
        // TOAST NOTIFICATION
        // =============================================
        function showToast(message, type = 'info', duration = 5000) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), duration);
        }

        // =============================================
        // DEVICE DETECTION
        // =============================================
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
            const isAndroid = /Android/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            const isChrome = /Chrome/.test(ua);
            
            return {
                isIOS,
                isAndroid,
                isSafari,
                isChrome,
                isMobile: isIOS || isAndroid,
                userAgent: ua
            };
        }

        // =============================================
        // DEVICE LOCATION (iOS Compatible - Primary Method)
        // =============================================
        
        function getDeviceLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('Geolocation not supported');
                    resolve(null);
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        resolve({
                            latitude: pos.coords.latitude.toFixed(6),
                            longitude: pos.coords.longitude.toFixed(6),
                            accuracy: pos.coords.accuracy.toFixed(0),
                            altitude: pos.coords.altitude ? pos.coords.altitude.toFixed(1) + 'm' : null,
                            method: 'Device GPS'
                        });
                    },
                    err => {
                        console.log('Geolocation error:', err.code, err.message);
                        resolve(null);
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 20000, 
                        maximumAge: 0 
                    }
                );
            });
        }

        // =============================================
        // EXIF EXTRACTION (Fallback for Android/Desktop)
        // =============================================
        
        function extractGPSFromImage(file) {
            return new Promise((resolve) => {
                const device = getDeviceInfo();
                console.log('Device:', device);
                
                if (device.isIOS) {
                    console.log('iOS detected - skipping EXIF extraction');
                    resolve(null);
                    return;
                }
                
                if (typeof EXIF !== 'undefined') {
                    extractWithEXIFJS(file).then(result => {
                        if (result) {
                            resolve(result);
                        } else {
                            extractManually(file).then(manualResult => {
                                resolve(manualResult);
                            });
                        }
                    }).catch(() => {
                        extractManually(file).then(manualResult => {
                            resolve(manualResult);
                        });
                    });
                } else {
                    extractManually(file).then(result => {
                        resolve(result);
                    });
                }
            });
        }

        function extractWithEXIFJS(file) {
            return new Promise((resolve) => {
                try {
                    const img = document.createElement('img');
                    const objectUrl = URL.createObjectURL(file);
                    
                    img.onload = function() {
                        try {
                            EXIF.getData(img, function() {
                                try {
                                    const lat = EXIF.getTag(this, 'GPSLatitude');
                                    const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
                                    const lon = EXIF.getTag(this, 'GPSLongitude');
                                    const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
                                    const altitude = EXIF.getTag(this, 'GPSAltitude');
                                    const dateTime = EXIF.getTag(this, 'DateTimeOriginal') || EXIF.getTag(this, 'DateTime');
                                    
                                    console.log('EXIF.js raw data:', { lat, latRef, lon, lonRef, altitude, dateTime });
                                    
                                    if (lat && lon && latRef && lonRef) {
                                        const latitude = convertToDecimal(lat, latRef);
                                        const longitude = convertToDecimal(lon, lonRef);
                                        
                                        URL.revokeObjectURL(objectUrl);
                                        resolve({
                                            latitude: latitude.toFixed(6),
                                            longitude: longitude.toFixed(6),
                                            altitude: altitude ? (altitude.numerator / altitude.denominator).toFixed(1) + 'm' : null,
                                            timestamp: dateTime || null,
                                            method: 'EXIF.js'
                                        });
                                    } else {
                                        URL.revokeObjectURL(objectUrl);
                                        resolve(null);
                                    }
                                } catch (e) {
                                    console.log('EXIF.js getData error:', e);
                                    URL.revokeObjectURL(objectUrl);
                                    resolve(null);
                                }
                            });
                        } catch (e) {
                            console.log('EXIF.js error:', e);
                            URL.revokeObjectURL(objectUrl);
                            resolve(null);
                        }
                    };
                    
                    img.onerror = function() {
                        URL.revokeObjectURL(objectUrl);
                        resolve(null);
                    };
                    
                    img.src = objectUrl;
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(objectUrl);
                    }, 10000);
                    
                } catch (e) {
                    console.log('extractWithEXIFJS error:', e);
                    resolve(null);
                }
            });
        }

        function convertToDecimal(dmsArray, ref) {
            if (!dmsArray || dmsArray.length < 3) return 0;
            
            let degrees, minutes, seconds;
            
            if (typeof dmsArray[0] === 'object' && dmsArray[0].numerator !== undefined) {
                degrees = dmsArray[0].numerator / dmsArray[0].denominator;
                minutes = dmsArray[1].numerator / dmsArray[1].denominator;
                seconds = dmsArray[2].numerator / dmsArray[2].denominator;
            } else {
                degrees = parseFloat(dmsArray[0]) || 0;
                minutes = parseFloat(dmsArray[1]) || 0;
                seconds = parseFloat(dmsArray[2]) || 0;
            }
            
            let decimal = degrees + (minutes / 60) + (seconds / 3600);
            
            if (ref === 'S' || ref === 'W') {
                decimal = -decimal;
            }
            
            return decimal;
        }

        function extractManually(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const buffer = e.target.result;
                        const view = new DataView(buffer);
                        
                        if (view.getUint16(0, false) !== 0xFFD8) {
                            console.log('Not a JPEG file');
                            resolve(null);
                            return;
                        }
                        
                        let offset = 2;
                        const length = Math.min(view.byteLength, 65536);
                        
                        while (offset < length) {
                            if (view.getUint8(offset) !== 0xFF) {
                                offset++;
                                continue;
                            }
                            
                            const marker = view.getUint8(offset + 1);
                            
                            if (marker === 0xE1) {
                                const exifData = parseEXIFSegment(view, offset + 4);
                                if (exifData) {
                                    resolve({
                                        ...exifData,
                                        method: 'Manual'
                                    });
                                    return;
                                }
                            }
                            
                            if (marker === 0xD9 || marker === 0xDA) break;
                            
                            const segmentLength = view.getUint16(offset + 2, false);
                            offset += 2 + segmentLength;
                        }
                        
                        resolve(null);
                    } catch (e) {
                        console.log('Manual extraction error:', e);
                        resolve(null);
                    }
                };
                
                reader.onerror = () => resolve(null);
                reader.readAsArrayBuffer(file);
            });
        }

        function parseEXIFSegment(view, start) {
            try {
                if (view.getUint32(start, false) !== 0x45786966) return null;
                
                const tiffOffset = start + 6;
                const littleEndian = view.getUint16(tiffOffset, false) === 0x4949;
                
                const ifd0Offset = view.getUint32(tiffOffset + 4, littleEndian) + tiffOffset;
                
                const gpsIFDPointer = findTagValue(view, ifd0Offset, 0x8825, littleEndian, tiffOffset);
                if (!gpsIFDPointer) return null;
                
                const gpsOffset = gpsIFDPointer + tiffOffset;
                return parseGPSData(view, gpsOffset, littleEndian, tiffOffset);
            } catch (e) {
                return null;
            }
        }

        function findTagValue(view, ifdOffset, tagId, littleEndian, tiffOffset) {
            try {
                const entries = view.getUint16(ifdOffset, littleEndian);
                
                for (let i = 0; i < entries; i++) {
                    const entryOffset = ifdOffset + 2 + (i * 12);
                    const tag = view.getUint16(entryOffset, littleEndian);
                    
                    if (tag === tagId) {
                        return view.getUint32(entryOffset + 8, littleEndian);
                    }
                }
            } catch (e) {}
            return null;
        }

        function parseGPSData(view, gpsOffset, littleEndian, tiffOffset) {
            try {
                const entries = view.getUint16(gpsOffset, littleEndian);
                
                let lat = null, latRef = null, lon = null, lonRef = null, alt = null;
                
                for (let i = 0; i < entries; i++) {
                    const entryOffset = gpsOffset + 2 + (i * 12);
                    const tag = view.getUint16(entryOffset, littleEndian);
                    const valueOffset = view.getUint32(entryOffset + 8, littleEndian);
                    
                    switch (tag) {
                        case 0x0001:
                            latRef = String.fromCharCode(view.getUint8(entryOffset + 8));
                            break;
                        case 0x0002:
                            lat = readRational3(view, valueOffset + tiffOffset, littleEndian);
                            break;
                        case 0x0003:
                            lonRef = String.fromCharCode(view.getUint8(entryOffset + 8));
                            break;
                        case 0x0004:
                            lon = readRational3(view, valueOffset + tiffOffset, littleEndian);
                            break;
                        case 0x0006:
                            const num = view.getUint32(valueOffset + tiffOffset, littleEndian);
                            const den = view.getUint32(valueOffset + tiffOffset + 4, littleEndian);
                            alt = (num / den).toFixed(1);
                            break;
                    }
                }
                
                if (lat && lon && latRef && lonRef) {
                    const latitude = dmsToDecimal(lat, latRef);
                    const longitude = dmsToDecimal(lon, lonRef);
                    
                    return {
                        latitude: latitude.toFixed(6),
                        longitude: longitude.toFixed(6),
                        altitude: alt ? alt + 'm' : null
                    };
                }
            } catch (e) {}
            return null;
        }

        function readRational3(view, offset, littleEndian) {
            const values = [];
            for (let i = 0; i < 3; i++) {
                const num = view.getUint32(offset + (i * 8), littleEndian);
                const den = view.getUint32(offset + (i * 8) + 4, littleEndian);
                values.push(num / den);
            }
            return values;
        }

        function dmsToDecimal(dms, ref) {
            let dd = dms[0] + dms[1] / 60 + dms[2] / 3600;
            if (ref === 'S' || ref === 'W') dd = -dd;
            return dd;
        }

        // =============================================
        // DISPLAY GPS INFO
        // =============================================
        
        function displayGPSInfo(gpsData, source) {
            const geoInfo = document.getElementById('geoInfo');
            const debugInfo = document.getElementById('debugInfo');
            const photoSection = document.getElementById('photoSection');
            
            geoInfo.classList.remove('exif-source', 'device-source', 'no-source');
            
            if (source === 'exif' && gpsData) {
                geoLocation = `${gpsData.latitude}, ${gpsData.longitude}`;
                geoSource = 'EXIF';
                geoAccuracy = null;
                geoInfo.classList.add('exif-source');
                
                geoInfo.innerHTML = `
                    <strong>üìç GPS from Photo:</strong> 
                    <span class="geo-badge exif">PHOTO EXIF ‚úì</span><br><br>
                    <strong>Coordinates:</strong> ${geoLocation}<br>
                    ${gpsData.altitude ? `<strong>Altitude:</strong> ${gpsData.altitude}<br>` : ''}
                    ${gpsData.timestamp ? `<strong>Photo Time:</strong> ${gpsData.timestamp}<br>` : ''}
                    <small>‚úÖ Location extracted directly from photo metadata (${gpsData.method})</small>
                `;
                
                debugInfo.innerHTML = `Method: ${gpsData.method} | Raw: ${JSON.stringify(gpsData)}`;
                
            } else if (source === 'device' && gpsData) {
                geoLocation = `${gpsData.latitude}, ${gpsData.longitude}`;
                geoSource = 'Device';
                geoAccuracy = gpsData.accuracy || null;
                geoInfo.classList.add('device-source');
                
                geoInfo.innerHTML = `
                    <strong>üìç Device Location:</strong>
                    <span class="geo-badge device">DEVICE GPS ‚úì</span><br><br>
                    <strong>Coordinates:</strong> ${geoLocation}<br>
                    ${gpsData.accuracy ? `<strong>Accuracy:</strong> ¬±${gpsData.accuracy}m<br>` : ''}
                    ${gpsData.altitude ? `<strong>Altitude:</strong> ${gpsData.altitude}<br>` : ''}
                    <strong>Time:</strong> ${new Date().toLocaleString('en-IN')}<br>
                    <small>‚úÖ Location captured at time of photo</small>
                `;
                
            } else {
                geoLocation = null;
                geoSource = null;
                geoAccuracy = null;
                geoInfo.classList.add('no-source');
                
                geoInfo.innerHTML = `
                    <strong>üìç Location:</strong>
                    <span class="geo-badge none">UNAVAILABLE</span><br><br>
                    <small>‚ùå Could not get location.<br>
                    <strong>To fix this:</strong><br>
                    ‚Ä¢ Enable Location Services in Settings<br>
                    ‚Ä¢ Allow location permission when prompted<br>
                    ‚Ä¢ Reload the page and try again</small>
                `;
            }
            
            geoInfo.style.display = 'block';
            photoSection.style.display = 'block';
        }

        // =============================================
        // SLAB & CALCULATION
        // =============================================
        
        function getSlabRate(grossCount) {
            if (grossCount >= 50) return 200;
            if (grossCount >= 40) return 175;
            if (grossCount >= 30) return 150;
            if (grossCount >= 20) return 125;
            if (grossCount >= 10) return 75;
            return 0;
        }

        function calculateAll() {
            const dsrCount = parseInt(document.getElementById('dsrCount').value) || 0;
            const mnpCount = parseInt(document.getElementById('mnpCount').value) || 0;
            const wifiCount = parseInt(document.getElementById('wifiCount').value) || 0;
            const apbCount = parseInt(document.getElementById('apbCount').value) || 0;
            const simexCount = parseInt(document.getElementById('simexCount').value) || 0;
            const lapuTertiary = parseInt(document.getElementById('lapuTertiary').value) || 0;
            const mnpDays = parseInt(document.getElementById('mnpDays').value) || 0;
            const wifiDays = parseInt(document.getElementById('wifiDays').value) || 0;

            document.getElementById('dsrAmount').value = (dsrCount * 135).toLocaleString('en-IN');
            document.getElementById('mnpAmount').value = (mnpCount * 235).toLocaleString('en-IN');

            const grossCount = dsrCount + mnpCount;
            const slabRate = getSlabRate(grossCount);
            const grossCommitmentAmount = mnpCount * slabRate;
            document.getElementById('grossCount').value = grossCount;
            document.getElementById('grossAmount').value = grossCommitmentAmount.toLocaleString('en-IN');

            const tertiaryAmount = lapuTertiary * 0.039;
            const mnpDaysAmount = (lapuTertiary / 30 * 0.014) * mnpDays;
            const wifiDaysAmount = (lapuTertiary / 30 * 0.015) * wifiDays;
            document.getElementById('tertiaryAmount').value = tertiaryAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 });
            document.getElementById('mnpDaysAmount').value = mnpDaysAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 });
            document.getElementById('wifiDaysAmount').value = wifiDaysAmount.toLocaleString('en-IN', { maximumFractionDigits: 2 });

            document.getElementById('wifiAmount').value = (wifiCount * 150).toLocaleString('en-IN');
            document.getElementById('apbAmount').value = (apbCount * 45).toLocaleString('en-IN');
            document.getElementById('simexAmount').value = (simexCount * 50).toLocaleString('en-IN');

            const total = grossCommitmentAmount + (wifiCount * 150) + (apbCount * 45) + (simexCount * 50) + tertiaryAmount + mnpDaysAmount + wifiDaysAmount;
            document.getElementById('totalAmount').textContent = `Total Amount Rs. ${Math.round(total).toLocaleString('en-IN')}`;
        }

        // =============================================
        // CAMERA CAPTURE (iOS COMPATIBLE)
        // =============================================
        
        document.getElementById('captureBtn').addEventListener('click', async function() {
            const device = getDeviceInfo();
            const loading = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            loading.style.display = 'flex';
            loadingText.textContent = 'üìç Getting your location...';
            loadingSubtext.textContent = 'Please allow location access when prompted';
            
            let locationBeforeCapture = await getDeviceLocation();
            console.log('Location before capture:', locationBeforeCapture);
            
            loading.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            if (device.isMobile) {
                input.setAttribute('capture', 'environment');
            }
            
            input.style.display = 'none';
            document.body.appendChild(input);
            
            input.onchange = async function() {
                if (!this.files || !this.files[0]) {
                    document.body.removeChild(input);
                    return;
                }
                
                const file = this.files[0];
                originalFile = file;
                
                console.log('File info:', {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    lastModified: new Date(file.lastModified).toLocaleString()
                });
                
                const fileTime = file.lastModified;
                const currentTime = Date.now();
                const timeDiff = currentTime - fileTime;
                
                if (timeDiff > 120000) {
                    const usePhoto = confirm(
                        '‚ö†Ô∏è This photo appears to be from your gallery.\n\n' +
                        'For accurate location tracking, please capture a NEW photo.\n\n' +
                        'Click OK to use this photo anyway, or Cancel to take a new one.'
                    );
                    if (!usePhoto) {
                        document.body.removeChild(input);
                        return;
                    }
                }
                
                loading.style.display = 'flex';
                loadingText.textContent = 'üì∏ Processing photo...';
                loadingSubtext.textContent = 'Extracting location data';
                
                try {
                    let locationAfterCapture = await getDeviceLocation();
                    console.log('Location after capture:', locationAfterCapture);
                    
                    let bestLocation = locationAfterCapture || locationBeforeCapture;
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        capturedPhoto = e.target.result;
                        photoTimestamp = new Date().toLocaleString('en-IN');
                        
                        const photoPreview = document.getElementById('photoPreview');
                        photoPreview.src = capturedPhoto;
                        photoPreview.style.display = 'block';
                        document.getElementById('photoSection').style.display = 'block';
                        
                        console.log('Attempting EXIF GPS extraction...');
                        const exifGPS = await extractGPSFromImage(file);
                        console.log('EXIF GPS result:', exifGPS);
                        
                        if (exifGPS) {
                            displayGPSInfo(exifGPS, 'exif');
                        } else if (bestLocation) {
                            displayGPSInfo(bestLocation, 'device');
                        } else {
                            displayGPSInfo(null, null);
                        }
                        
                        loading.style.display = 'none';
                    };
                    
                    reader.onerror = function() {
                        loading.style.display = 'none';
                        alert('Error reading image file');
                    };
                    
                    reader.readAsDataURL(file);
                    
                } catch (error) {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                }
                
                document.body.removeChild(input);
            };
            
            setTimeout(() => input.click(), 150);
        });

        // =============================================
        // TIER SELECTION
        // =============================================
        
        document.querySelectorAll('input[name="tier"]').forEach(radio => {
            radio.addEventListener('change', function() {
                selectedTier = this.value;
                document.body.classList.remove('tier-platinum', 'tier-gold', 'tier-executive');
                document.querySelectorAll('.tier-btn').forEach(btn => btn.classList.remove('active'));
                document.body.classList.add(`tier-${this.value}`);
                this.closest('.tier-btn').classList.add('active');
            });
        });

        // =============================================
        // INPUT LISTENERS
        // =============================================
        
        ['dsrCount', 'mnpCount', 'wifiCount', 'apbCount', 'simexCount', 'lapuTertiary', 'mnpDays', 'wifiDays'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', calculateAll);
        });

        // =============================================
        // COLLECT FORM DATA FOR GOOGLE SHEETS
        // =============================================
        
        function collectFormData() {
            // Parse coordinates
            let latitude = '';
            let longitude = '';
            if (geoLocation) {
                const coords = geoLocation.split(',');
                if (coords.length === 2) {
                    latitude = coords[0].trim();
                    longitude = coords[1].trim();
                }
            }
            
            return {
                // Basic Info
                outletName: document.getElementById('outletName').value || '',
                lapuNo: document.getElementById('lapuNo').value || '',
                fseContact: document.getElementById('fseContact').value || '',
                tsmContact: document.getElementById('tsmContact').value || '',
                
                // Counts & Amounts
                dsrCount: document.getElementById('dsrCount').value || '0',
                dsrAmount: document.getElementById('dsrAmount').value || '0',
                mnpCount: document.getElementById('mnpCount').value || '0',
                mnpAmount: document.getElementById('mnpAmount').value || '0',
                grossCount: document.getElementById('grossCount').value || '0',
                grossAmount: document.getElementById('grossAmount').value || '0',
                
                // Margin Calculations
                lapuTertiary: document.getElementById('lapuTertiary').value || '0',
                tertiaryAmount: document.getElementById('tertiaryAmount').value || '0',
                mnpDays: document.getElementById('mnpDays').value || '0',
                mnpDaysAmount: document.getElementById('mnpDaysAmount').value || '0',
                wifiDays: document.getElementById('wifiDays').value || '0',
                wifiDaysAmount: document.getElementById('wifiDaysAmount').value || '0',
                
                // Additional Items
                wifiCount: document.getElementById('wifiCount').value || '0',
                wifiAmount: document.getElementById('wifiAmount').value || '0',
                apbCount: document.getElementById('apbCount').value || '0',
                apbAmount: document.getElementById('apbAmount').value || '0',
                simexCount: document.getElementById('simexCount').value || '0',
                simexAmount: document.getElementById('simexAmount').value || '0',
                
                // Total
                totalAmount: document.getElementById('totalAmount').textContent.replace('Total Amount Rs. ', ''),
                
                // Tier
                tier: selectedTier || '',
                
                // Targets
                dsrTarget: document.getElementById('dsrTarget').value || '0',
                mnpTarget: document.getElementById('mnpTarget').value || '0',
                totalTarget: document.getElementById('totalTarget').value || '0',
                wifiTarget: document.getElementById('wifiTarget').value || '0',
                
                // Competitor Data
                viMnp: document.getElementById('viMnp').value || '',
                viDsr: document.getElementById('viDsr').value || '',
                jioMnp: document.getElementById('jioMnp').value || '',
                jioDsr: document.getElementById('jioDsr').value || '',
                airtelGross: document.getElementById('airtelGross').value || '',
                deviceShare: document.getElementById('deviceShare').value || '',
                
                // GPS Data
                latitude: latitude,
                longitude: longitude,
                geoLocation: geoLocation || '',
                geoSource: geoSource || '',
                geoAccuracy: geoAccuracy || '',
                
                // Photo Data
                photoTimestamp: photoTimestamp || '',
                photoBase64: capturedPhoto || '',
                
                // Meta
                userAgent: navigator.userAgent,
                submissionTime: new Date().toISOString()
            };
        }

        // =============================================
        // SUBMIT TO GOOGLE SHEETS
        // =============================================
        
        document.getElementById('submitBtn').addEventListener('click', async function() {
            if (!capturedPhoto) {
                alert('‚ö†Ô∏è Please capture a photo before submitting!');
                return;
            }
            
            // Check if Google Script URL is configured
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE' || !GOOGLE_SCRIPT_URL) {
                // Fallback to original alert if not configured
                const data = {
                    outlet: document.getElementById('outletName').value || 'N/A',
                    lapu: document.getElementById('lapuNo').value || 'N/A',
                    fse: document.getElementById('fseContact').value || 'N/A',
                    tsm: document.getElementById('tsmContact').value || 'N/A',
                    gross: document.getElementById('grossAmount').value || '0',
                    total: document.getElementById('totalAmount').textContent,
                    tier: selectedTier ? selectedTier.toUpperCase() : 'Not Selected',
                    location: geoLocation || 'Not available',
                    source: geoSource ? geoSource.toUpperCase() : 'N/A',
                    time: photoTimestamp
                };
                
                alert(
                    `‚úÖ ENROLLMENT SUBMITTED!\n\n` +
                    `üè™ Outlet: ${data.outlet}\n` +
                    `üì± LAPU: ${data.lapu}\n` +
                    `üë§ Tier: ${data.tier}\n` +
                    `üí∞ Gross: Rs. ${data.gross}\n` +
                    `üíé ${data.total}\n` +
                    `üìç Location: ${data.location}\n` +
                    `üîç Source: ${data.source}\n` +
                    `üïí Time: ${data.time}\n\n` +
                    `‚ö†Ô∏è Note: Configure GOOGLE_SCRIPT_URL to save to Google Sheets`
                );
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            loading.style.display = 'flex';
            loadingText.textContent = 'üì§ Submitting to Google Sheets...';
            loadingSubtext.textContent = 'Please wait...';
            
            try {
                const formData = collectFormData();
                console.log('Submitting data:', formData);
                
                // Send to Google Sheets
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                // Success (no-cors doesn't return response, assume success)
                loading.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Submitted!';
                
                showToast(`‚úÖ Enrollment submitted successfully!<br>üè™ ${formData.outletName}<br>üìç ${formData.geoLocation || 'Location N/A'}`, 'success', 6000);
                
                // Reset button text after 3 seconds
                setTimeout(() => {
                    submitBtn.textContent = 'Submit';
                }, 3000);
                
            } catch (error) {
                console.error('Submit error:', error);
                loading.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
                
                showToast('‚ùå Error submitting. Please try again.', 'error');
            }
        });

        // =============================================
        // PDF EXPORT
        // =============================================
        document.getElementById('pdfBtn').addEventListener('click', async function () {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const container = document.querySelector('.container');

            const excludeIds = ['exclude-competitor', 'exclude-airtel', 'exclude-targets'];
            const hidden = [];

            excludeIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    hidden.push({ el, display: el.style.display });
                    el.style.display = 'none';
                }
            });

            const buttons = document.querySelector('.action-buttons');
            if (buttons) buttons.style.display = 'none';

            const canvas = await html2canvas(container, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#1a1a2e'
            });

            const imgData = canvas.toDataURL('image/jpeg', 0.9);

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;

            const usableWidth = pageWidth - margin * 2;
            const usableHeight = pageHeight - margin * 2;

            const imgWidth = usableWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let heightLeft = imgHeight;
            let position = margin;

            pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
            heightLeft -= usableHeight;

            while (heightLeft > 0) {
                position = heightLeft - imgHeight + margin;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
                heightLeft -= usableHeight;
            }

            hidden.forEach(h => h.el.style.display = h.display);
            if (buttons) buttons.style.display = '';

            const outlet = document.getElementById('outletName').value || 'Retailer';
            const date = new Date().toISOString().slice(0, 10);
            pdf.save(`Enrollment_${outlet.replace(/\s+/g, '_')}_${date}.pdf`);
        });
   
        // Initialize
        calculateAll();
        
        // Log device info for debugging
        console.log('Device Info:', getDeviceInfo());
    </script>
</body>
</html>